<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DALORF - Challenge for Friends</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Montserrat font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-main: 'Montserrat', 'Segoe UI', Arial, sans-serif;
    }

    body {
      font-family: var(--font-main);
      margin: 0; padding: 0;
      text-align: center;
      overflow-x: hidden;
      transition: background 0.4s, color 0.4s;
    }

    /* Enhanced focus outlines for accessibility */
    *:focus {
      outline: 3px solid;
      outline-offset: 2px;
    }

    .light-theme {
      background: linear-gradient(120deg, #ffd6e1 0%, #c9f6f9 100%);
      color: #222;
      font-family: var(--font-main);
    }
    .light-theme *:focus {
      outline-color: #ff80a8;
    }
    .light-theme h1 {
      font-size: 2.7em;
      font-weight: 700;
      color: #232323;
      margin: 0;
      letter-spacing: 0.5px;
      line-height: 1.15;
      font-family: var(--font-main);
    }
    .light-theme h3 {
      font-size: 1.35em;
      font-weight: 600;
      color: #232323;
      margin-bottom: 24px;
      margin-top: 0;
      font-family: var(--font-main);
    }
    .light-theme input, .light-theme select {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      border: 1.5px solid #d8e0e6;
      background: #f5f8fa;
      color: #232323;
      outline: none;
      transition: border 0.3s;
      box-sizing: border-box;
      min-height: 44px; /* Larger tap targets */
      padding: 6px;
    }
    .light-theme input:focus, .light-theme select:focus {
      border-color: #ff80a8;
      box-shadow: 0 0 7px #ffb7d1bb;
    }
    .light-theme button {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      background: #ff80a8;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 12px 24px; /* Larger tap targets */
      margin: 8px 6px 0 0;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: 0 2px 8px #ffb7d155;
      letter-spacing: 0.4px;
      min-height: 44px;
    }
    .light-theme button:hover:not(:disabled) {
      background: #ff5a91;
      transform: scale(1.05);
    }
    .light-theme button:disabled {
      background: #eee;
      color: #aaa;
      cursor: not-allowed;
    }
    .light-theme .question-block {
      background: #fff;
      color: #232323;
      font-family: var(--font-main);
      box-shadow: 0 4px 16px 0 #e6f4f8bb;
      border-radius: 10px;
      padding: 18px 16px;
      margin: 18px auto;
      max-width: 500px;
      text-align: left;
      position: relative;
    }
    .light-theme .question-block .main-question-input {
      background: #fff6c1;
      border: 2px solid #ffb700;
      font-weight: bold;
      font-size: 1.13em;
      margin-bottom: 8px;
      display: block;
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      color: #232323;
      padding: 8px;
    }
    .light-theme .question-block .option-input {
      background: #f0f0f0;
      border: 1.2px solid #ccc;
      margin-bottom: 6px;
      width: 90%; /* Improved mobile width */
      min-width: 120px;
      max-width: 90%;
      box-sizing: border-box;
      display: inline-block;
      color: #232323;
      padding: 6px;
    }
    .light-theme .timer {
      color: #ff5a91;
      font-weight: 700;
      font-family: var(--font-main);
    }
    .light-theme .timer.low-time {
      color: #ff80a8;
    }
    .light-theme .theme-switch {
      color: #ff80a8;
      background: none;
      font-size: 1.7em;
      border-radius: 50%;
      border: none;
      padding: 8px 12px; /* Larger tap target */
      cursor: pointer;
      transition: background 0.2s;
      margin: 0;
      position: absolute;
      top: 18px;
      right: 20px;
      min-height: 44px;
      min-width: 44px;
    }
    .light-theme .theme-switch:hover {
      background: #ffe0ec;
    }
    .light-theme .loading-indicator {
      color: #ff80a8;
      font-size: 1.1em;
      margin: 14px 0;
      animation: pulse-loading 1.2s infinite;
    }
    .light-theme .error-message {
      color: #d32f2f;
      background: #ffebee;
      border: 1px solid #ffcdd2;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.9em;
    }
    .light-theme .success-message {
      color: #388e3c;
      background: #e8f5e8;
      border: 1px solid #c8e6c9;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.9em;
    }
    .light-theme .notification {
      background: #e3f2fd;
      color: #1976d2;
      border: 2px solid #bbdefb;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 500px;
      animation: slideIn 0.5s ease;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
    }
    .light-theme .room-info {
      background: #f3e5f5;
      color: #7b1fa2;
      border: 2px solid #ce93d8;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 500px;
      font-weight: 600;
    }

    .dark-theme {
      background: linear-gradient(135deg, #745100 0%, #000000 100%);
      color: #fff;
      font-family: var(--font-main);
    }
    .dark-theme *:focus {
      outline-color: #ffd26b;
    }
    .dark-theme h1 {
      font-size: 2.7em;
      font-weight: 700;
      color: #ffd26b;
      letter-spacing: 0.5px;
      font-family: var(--font-main);
      margin: 0;
      line-height: 1.15;
    }
    .dark-theme h3 {
      font-size: 1.25em;
      font-weight: 600;
      color: #ffe9b3;
      margin-bottom: 24px;
      margin-top: 0;
      font-family: var(--font-main);
    }
    .dark-theme input, .dark-theme select {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      border: 1.5px solid #444;
      background: #222;
      color: #fff;
      outline: none;
      transition: border 0.3s;
      box-sizing: border-box;
      min-height: 44px;
      padding: 6px;
    }
    .dark-theme input:focus, .dark-theme select:focus {
      border-color: #ffd26b;
      box-shadow: 0 0 7px #ffd26bbb;
    }
    .dark-theme button {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      background: #ff567d;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 12px 24px;
      margin: 8px 6px 0 0;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: 0 2px 8px #ffd26b55;
      letter-spacing: 0.4px;
      min-height: 44px;
    }
    .dark-theme button:hover:not(:disabled) {
      background: #ffd26b;
      color: #432200;
      transform: scale(1.05);
    }
    .dark-theme button:disabled {
      background: #444;
      color: #ccc;
      cursor: not-allowed;
    }
    .dark-theme .question-block {
      background: #222;
      color: #fff;
      font-family: var(--font-main);
      box-shadow: 0 4px 16px 0 #000000bb;
      border-radius: 10px;
      padding: 18px 16px;
      margin: 18px auto;
      max-width: 500px;
      text-align: left;
      position: relative;
    }
    .dark-theme .question-block .main-question-input {
      background: #4c3700;
      border: 2px solid #ffd26b;
      color: #fff;
      font-weight: bold;
      font-size: 1.13em;
      margin-bottom: 8px;
      display: block;
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 8px;
    }
    .dark-theme .question-block .option-input {
      background: #181818;
      border: 1.2px solid #555;
      color: #fff;
      margin-bottom: 6px;
      width: 90%;
      min-width: 120px;
      max-width: 90%;
      box-sizing: border-box;
      display: inline-block;
      padding: 6px;
    }
    .dark-theme .timer {
      color: #ffd26b;
      font-weight: 700;
      font-family: var(--font-main);
    }
    .dark-theme .timer.low-time {
      color: #ff567d;
    }
    .dark-theme .theme-switch {
      color: #ffd26b;
      background: none;
      font-size: 1.7em;
      border-radius: 50%;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 0;
      position: absolute;
      top: 18px;
      right: 20px;
      min-height: 44px;
      min-width: 44px;
    }
    .dark-theme .theme-switch:hover {
      background: #432200;
    }
    .dark-theme .loading-indicator {
      color: #ffd26b;
      font-size: 1.1em;
      margin: 14px 0;
      animation: pulse-loading 1.2s infinite;
    }
    .dark-theme .error-message {
      color: #f44336;
      background: #2d1b1b;
      border: 1px solid #5d2f2f;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.9em;
    }
    .dark-theme .success-message {
      color: #4caf50;
      background: #1b2d1b;
      border: 1px solid #2f5d2f;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.9em;
    }
    .dark-theme .notification {
      background: #1a1a2e;
      color: #64b5f6;
      border: 2px solid #16213e;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 500px;
      animation: slideIn 0.5s ease;
      box-shadow: 0 4px 12px rgba(100, 181, 246, 0.2);
    }
    .dark-theme .room-info {
      background: #2d1b3d;
      color: #ba68c8;
      border: 2px solid #4a148c;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 500px;
      font-weight: 600;
    }

    /* About name button */
    .about-name-btn {
      background: none;
      border: none;
      font-size: 1.1em;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s, transform 0.2s;
      padding: 5px 8px;
      border-radius: 50%;
      min-height: 32px;
      min-width: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .light-theme .about-name-btn {
      color: #ff80a8;
    }
    .light-theme .about-name-btn:hover {
      opacity: 1;
      background: #ffe0ec;
      transform: scale(1.1);
    }
    .dark-theme .about-name-btn {
      color: #ffd26b;
    }
    .dark-theme .about-name-btn:hover {
      opacity: 1;
      background: #432200;
      transform: scale(1.1);
    }

    .section {
      animation: fadeIn 0.6s ease;
    }
    .question-block {
      transition: transform 0.3s, box-shadow 0.3s;
      animation: fadeInUp 0.5s ease;
    }
    .question-block:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.13);
    }
    .option-input { display: block; }
    .hidden { display: none; }
    .timer {
      font-weight: bold;
      animation: fadeIn 0.5s ease;
    }
    .timer.low-time {
      animation: pulse 1s infinite;
    }
    .error { border: 1px solid red; }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: var(--modal-bg, #fff);
      color: var(--modal-color, #222);
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: fadeInUp 0.3s ease;
    }
    .light-theme .modal-content {
      --modal-bg: #fff;
      --modal-color: #222;
    }
    .dark-theme .modal-content {
      --modal-bg: #222;
      --modal-color: #fff;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    .close:hover,
    .close:focus {
      color: #000;
    }
    .dark-theme .close:hover,
    .dark-theme .close:focus {
      color: #fff;
    }

    /* Confetti animation */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #ff80a8;
      animation: confetti-fall 3s linear infinite;
      z-index: 1000;
      pointer-events: none;
    }
    .confetti:nth-child(odd) { background: #ffd26b; }
    .confetti:nth-child(3n) { background: #ff567d; }
    .confetti:nth-child(4n) { background: #4caf50; }
    .confetti:nth-child(5n) { background: #2196f3; }

    /* State transition message */
    .state-message {
      font-size: 1.3em;
      font-weight: 600;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      max-width: 500px;
      animation: fadeInUp 0.5s ease;
    }
    .light-theme .state-message {
      background: #e3f2fd;
      color: #1976d2;
      border: 2px solid #bbdefb;
    }
    .dark-theme .state-message {
      background: #1a1a2e;
      color: #64b5f6;
      border: 2px solid #16213e;
    }

    /* Live regions for screen readers */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .automated-questions {
      margin: 20px auto;
      max-width: 500px;
      padding: 15px;
      border-radius: 10px;
      text-align: left;
    }
    .light-theme .automated-questions {
      background: #f0f8f0;
      border: 2px solid #4caf50;
    }
    .dark-theme .automated-questions {
      background: #1b2d1b;
      border: 2px solid #4caf50;
    }

    .intensity-selector {
      margin: 15px 0;
    }

    .intensity-selector label {
      display: block;
      margin: 8px 0;
      cursor: pointer;
      font-weight: 500;
    }

    .question-count-selector {
      margin: 20px auto;
      max-width: 500px;
      padding: 15px;
      border-radius: 10px;
    }
    .light-theme .question-count-selector {
      background: #fff3e0;
      border: 2px solid #ff9800;
    }
    .dark-theme .question-count-selector {
      background: #2d1b00;
      border: 2px solid #ff9800;
    }

    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    @keyframes fadeInDown { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
    @keyframes fadeInUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
    @keyframes slideIn { 
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1);}
      50% { transform: scale(1.1);}
    }
    @keyframes pulse-loading {
      0%, 100% { opacity: 1;}
      50% { opacity: 0.5;}
    }
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    @media (max-width: 600px) {
      .light-theme h1, .dark-theme h1 { font-size: 2em; }
      .light-theme h3, .dark-theme h3 { font-size: 1.1em; }
      .question-block { max-width: 98vw; padding: 11px 4vw; }
      .theme-switch { top: 8px; right: 8px; }
      .about-name-btn { font-size: 1em; min-height: 28px; min-width: 28px; padding: 3px 6px; }
      .question-block .option-input, .dark-theme .question-block .option-input {
        width: 95%;
        min-width: 70px;
        max-width: 100%;
      }
      .modal-content {
        margin: 2% auto;
        width: 95%;
        max-height: 90vh;
      }
    }
    .edit-btn, .delete-btn, .pause-edit-btn {
      font-size: 0.95em;
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      min-height: 36px;
    }
    .edit-btn:hover, .delete-btn:hover, .pause-edit-btn:hover {
      opacity: 1;
    }
    .edit-btn {
      background: #ffe9b3;
      color: #222;
    }
    .delete-btn {
      background: #ff567d;
      color: #fff;
    }
    .pause-edit-btn {
      background: #4caf50;
      color: #fff;
    }
    .edit-btn:disabled, .delete-btn:disabled, .pause-edit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database-compat.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAvaDuz1OCKYuDfieZiHynhYkur9KOPY00",
      authDomain: "birdview-025802.firebaseapp.com",
      databaseURL: "https://birdview-025802-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "birdview-025802",
      storageBucket: "birdview-025802.firebasestorage.app",
      messagingSenderId: "607338097846",
      appId: "1:607338097846:web:2ac36ce8f1261664180a17",
      measurementId: "G-Z08YPG773L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body class="dark-theme">
  <!-- ARIA live regions for screen reader announcements -->
  <div id="announcements" class="sr-only" aria-live="polite"></div>
  <div id="timer-announcements" class="sr-only" aria-live="assertive"></div>
  <div id="notifications-container"></div>

  <button class="theme-switch" id="theme-switch" aria-label="Switch theme" title="Switch theme">üåû</button>
  
  <div style="text-align: center; margin-bottom: 20px; margin-top: 30px;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px;">
      <h1 style="margin: 0;">ü™® DALORF üêü</h1>
      <button id="about-name" class="about-name-btn" title="About the name DALORF" aria-label="About the name DALORF">‚ÑπÔ∏è</button>
    </div>
    <p style="font-size: 1.2em; margin: 0; font-weight: 600; opacity: 0.8;">Challenge for Friends</p>
  </div>

  <div id="room-info-display" class="room-info hidden">
    <div id="room-details"></div>
  </div>

  <div id="auth-section" class="section">
    <h3>Join or Create Game</h3>
    <p>Test how well you know each other! Create questions and see if your friend can answer them correctly.</p>
    <button onclick="showInstructions()" style="margin-bottom: 15px;">üìñ How to Play</button>
    <br>
    <input id="playerName" placeholder="Your Name" aria-label="Player Name">
    <div id="auth-error" class="error-message hidden"></div>
    <input id="roomCode" placeholder="Room Code (optional - leave empty for auto)" aria-label="Room Code">
    <div id="room-error" class="error-message hidden"></div>
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <div id="question-setup-section" class="section hidden">
    <h3>Game Setup</h3>
    <div class="question-count-selector">
      <h4>Number of Questions per Player:</h4>
      <select id="questionCount" aria-label="Number of questions">
        <option value="3">3 Questions</option>
        <option value="5" selected>5 Questions</option>
        <option value="7">7 Questions</option>
        <option value="10">10 Questions</option>
      </select>
      <br><br>
      <button onclick="startGameSetup()" id="start-setup-btn">Start Creating Questions</button>
    </div>
  </div>

  <div id="question-section" class="section hidden">
    <h3>Add Your Questions</h3>
    <p>Create personal questions that only someone who knows you well could answer!</p>
    
    <div class="automated-questions">
      <h4>Need Question Ideas? Try These:</h4>
      <div class="intensity-selector">
        <label><input type="radio" name="intensity" value="light" checked> Light (Basic preferences)</label>
        <label><input type="radio" name="intensity" value="medium"> Medium (Personal experiences)</label>
        <label><input type="radio" name="intensity" value="deep"> Deep (Values & dreams)</label>
      </div>
      <button onclick="generateAutomatedQuestions()">Get Question Suggestions</button>
      <div id="suggested-questions"></div>
    </div>
    
    <div id="questions-container"></div>
    <div id="question-error" class="error-message hidden"></div>
    <button onclick="addQuestion()">+ Add Question</button>
    <br>
    <button onclick="submitQuestions()" id="submit-btn">Submit Questions</button>
    <div id="review-timer-visible" style="display:none;">
      ‚è≥ Reflection Time Left: <span id="timer-visible" class="timer"></span>
      <button onclick="pauseAndEdit()" id="pause-edit-btn" class="pause-edit-btn">Pause & Edit</button>
    </div>
    <div id="state-transition" class="state-message hidden"></div>
  </div>

  <div id="waiting-section" class="section hidden">
    <div class="loading-indicator">
      ‚è≥ Waiting for the other player to submit questions...
      <span id="wait-timer" class="timer"></span>
    </div>
  </div>

  <div id="answer-section" class="section hidden">
    <h3>Answer Your Friend's Questions</h3>
    <div id="answer-container"></div>
    <div id="answer-error" class="error-message hidden"></div>
    <button onclick="submitAnswers()">Submit Answers</button>
    <div id="waiting-answers" class="hidden loading-indicator">‚è≥ Loading questions...</div>
  </div>

  <div id="result-section" class="section hidden">
    <h3>Results</h3>
    <div id="result-output"></div>
    <button onclick="location.reload()">Play Again</button>
  </div>

  <!-- About Name Modal -->
  <div id="about-name-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAboutName()">&times;</span>
      <h2>ü™® About DALORF üêü</h2>
      
      <p><strong>DALORF</strong> is a special combination of names that represents the friendship that inspired this game:</p>
      
      <div style="background: rgba(255, 208, 107, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffd26b;">
        <p><strong>DA</strong> - From some names of the female friend who inspired this creation</p>
        <p><strong>LO</strong> - From some of the creator's names</p>
        <p><strong>R, F</strong> - Rock & Fish - the nicknames we often call ourselves</p>
      </div>
      
      <p>This game was born from a real friendship where we wanted to test how well we truly know each other. The name DALORF carries that personal connection and celebrates the bond between Rock and Fish.</p>
      
      <p style="font-style: italic; text-align: center; margin-top: 20px;">
        "Every great friendship deserves its own challenge!" üíñ
      </p>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instructions-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInstructions()">&times;</span>
      <h2>üéØ How to Play DALORF</h2>
      
      <h3>üöÄ Getting Started</h3>
      <p><strong>Create a Room:</strong> Enter your name and click "Create Room" to get a unique room code.</p>
      <p><strong>Join a Room:</strong> Enter your name and the room code your friend shared, then click "Join Room".</p>
      
      <h3>‚ùì Question Phase</h3>
      <p><strong>Create Questions:</strong> Write personal questions about yourself with 4 multiple choice options.</p>
      <p><strong>Get Help:</strong> Use automated question suggestions with different intensity levels.</p>
      <p><strong>Examples:</strong> "What's my favorite pizza topping?", "Where did I go on my last vacation?", "What's my biggest fear?"</p>
      <p><strong>Review Time:</strong> You'll have 1 minute to review and edit your questions before they're locked in.</p>
      
      <h3>üéØ Answer Phase</h3>
      <p><strong>Answer Questions:</strong> Try to answer your friend's questions about them.</p>
      <p><strong>See Results:</strong> Find out how well you know each other!</p>
      
      <h3>üèÜ Scoring</h3>
      <p><strong>Perfect (100%):</strong> üíé Perfect Harmony</p>
      <p><strong>Excellent (90-99%):</strong> üíñ Soulmate Energy</p>
      <p><strong>Great (80-89%):</strong> üòä Close Confidant</p>
      <p><strong>Good (70-79%):</strong> ü§ù Good Friends</p>
      <p><strong>Fair (60-69%):</strong> üôÇ Getting There</p>
      <p><strong>Okay (50-59%):</strong> üòê Friendly Guesswork</p>
      <p><strong>Poor (40-49%):</strong> üòÖ We Need to Talk</p>
      <p><strong>Very Poor (30-39%):</strong> üò¨ Strangers Much?</p>
      <p><strong>Terrible (20-29%):</strong> ü§î Do You Even Know Me?</p>
      <p><strong>Disaster (10-19%):</strong> üò± Who Are You?</p>
      <p><strong>Complete Miss (0-9%):</strong> üëª Ghost Friends</p>
      
      <p><em>Tip: Make questions challenging but fair - the goal is to discover how well you know each other!</em></p>
    </div>
  </div>

  <script>
    // THEME SWITCHER
    const themeSwitchBtn = document.getElementById('theme-switch');
    const body = document.body;
    function setTheme(theme) {
      if (theme === 'light') {
        body.classList.add('light-theme');
        body.classList.remove('dark-theme');
        themeSwitchBtn.textContent = 'üåô';
        themeSwitchBtn.title = 'Switch to dark theme';
      } else {
        body.classList.add('dark-theme');
        body.classList.remove('light-theme');
        themeSwitchBtn.textContent = 'üåû';
        themeSwitchBtn.title = 'Switch to light theme';
      }
    }
    const savedTheme = localStorage.getItem('theme');
    setTheme(savedTheme || 'dark');
    themeSwitchBtn.onclick = function() {
      const isDark = body.classList.contains('dark-theme');
      setTheme(isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    };

    // AUTOMATED QUESTIONS DATABASE
    const automatedQuestions = {
      light: [
        { q: "What's my favorite color?", opts: ["Blue", "Red", "Green", "Purple"] },
        { q: "What's my favorite food?", opts: ["Pizza", "Burger", "Pasta", "Sushi"] },
        { q: "What's my favorite season?", opts: ["Spring", "Summer", "Fall", "Winter"] },
        { q: "What's my favorite movie genre?", opts: ["Action", "Comedy", "Romance", "Horror"] },
        { q: "What's my favorite drink?", opts: ["Coffee", "Tea", "Soda", "Water"] },
        { q: "What's my favorite animal?", opts: ["Dog", "Cat", "Bird", "Fish"] },
        { q: "What's my preferred weather?", opts: ["Sunny", "Rainy", "Cloudy", "Snowy"] },
        { q: "What's my favorite day of the week?", opts: ["Monday", "Wednesday", "Friday", "Saturday"] }
      ],
      medium: [
        { q: "What's my biggest fear?", opts: ["Heights", "Spiders", "Public speaking", "Dark"] },
        { q: "Where did I go on my last vacation?", opts: ["Beach", "Mountains", "City", "Countryside"] },
        { q: "What's my dream job?", opts: ["Teacher", "Doctor", "Artist", "Engineer"] },
        { q: "What makes me happiest?", opts: ["Friends", "Family", "Achievements", "Hobbies"] },
        { q: "What's my biggest pet peeve?", opts: ["Loud chewing", "Being late", "Messy spaces", "Interrupting"] },
        { q: "What's my favorite childhood memory?", opts: ["Birthday party", "Family trip", "School event", "Holiday"] },
        { q: "What sport did I play/want to play?", opts: ["Soccer", "Basketball", "Tennis", "Swimming"] },
        { q: "What's my guilty pleasure?", opts: ["Reality TV", "Junk food", "Online shopping", "Social media"] }
      ],
      deep: [
        { q: "What's my biggest life goal?", opts: ["Career success", "Family happiness", "Personal growth", "Making a difference"] },
        { q: "What do I value most in friendship?", opts: ["Loyalty", "Honesty", "Fun", "Support"] },
        { q: "What's my biggest regret?", opts: ["Not taking risks", "Hurting someone", "Missing opportunities", "Being too cautious"] },
        { q: "What motivates me the most?", opts: ["Recognition", "Personal satisfaction", "Helping others", "Competition"] },
        { q: "What's my philosophy on life?", opts: ["Live each day fully", "Plan for the future", "Help others", "Follow your dreams"] },
        { q: "What would I change about myself?", opts: ["Be more confident", "Be more patient", "Be more organized", "Be more social"] },
        { q: "What's my definition of success?", opts: ["Financial stability", "Personal happiness", "Impact on others", "Achieving goals"] },
        { q: "What's my biggest strength?", opts: ["Empathy", "Determination", "Creativity", "Leadership"] }
      ]
    };

    // UTILITY FUNCTIONS
    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
      setTimeout(() => errorEl.classList.add('hidden'), 5000);
    }

    function showSuccess(elementId, message) {
      const errorEl = document.getElementById(elementId);
      errorEl.textContent = message;
      errorEl.classList.remove('error-message');
      errorEl.classList.add('success-message');
      errorEl.classList.remove('hidden');
      setTimeout(() => {
        errorEl.classList.add('hidden');
        errorEl.classList.remove('success-message');
        errorEl.classList.add('error-message');
      }, 3000);
    }

    function showNotification(message, duration = 4000) {
      const container = document.getElementById('notifications-container');
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, duration);
    }

    function updateRoomInfo(roomCode, playerName, otherPlayer = null) {
      const roomInfo = document.getElementById('room-info-display');
      const roomDetails = document.getElementById('room-details');
      
      let content = `üè† Room: ${roomCode} | üë§ You: ${playerName}`;
      if (otherPlayer) {
        content += ` | üë• Joined: ${otherPlayer}`;
      }
      
      roomDetails.textContent = content;
      roomInfo.classList.remove('hidden');
    }

    function announceToScreenReader(message, urgent = false) {
      const announceEl = document.getElementById(urgent ? 'timer-announcements' : 'announcements');
      announceEl.textContent = message;
      setTimeout(() => announceEl.textContent = '', 1000);
    }

    function showStateMessage(message) {
      const stateEl = document.getElementById('state-transition');
      stateEl.textContent = message;
      stateEl.classList.remove('hidden');
      setTimeout(() => stateEl.classList.add('hidden'), 4000);
    }

    function generateAutomatedQuestions() {
      const intensity = document.querySelector('input[name="intensity"]:checked').value;
      const questions = automatedQuestions[intensity];
      const suggestedContainer = document.getElementById('suggested-questions');
      
      // Get 3 random questions
      const randomQuestions = questions.sort(() => 0.5 - Math.random()).slice(0, 3);
      
      suggestedContainer.innerHTML = '<h5>Suggested Questions:</h5>' + 
        randomQuestions.map((q, i) => 
          `<div style="margin: 10px 0; padding: 10px; border-left: 3px solid #4caf50; background: rgba(76, 175, 80, 0.1);">
            <strong>${q.q}</strong><br>
            <small>Options: ${q.opts.join(', ')}</small><br>
            <button onclick="useAutomatedQuestion(${JSON.stringify(q).replace(/"/g, '&quot;')})" style="margin-top: 5px; font-size: 0.9em;">Use This Question</button>
          </div>`
        ).join('');
    }

    function useAutomatedQuestion(questionData) {
      const qData = {
        question: questionData.q,
        options: questionData.opts,
        correct: "" // User will need to select the correct answer
      };
      addQuestion(qData);
    }

    // ABOUT NAME MODAL
    function showAboutName() {
      document.getElementById('about-name-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeAboutName() {
      document.getElementById('about-name-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // INSTRUCTIONS MODAL
    function showInstructions() {
      document.getElementById('instructions-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeInstructions() {
      document.getElementById('instructions-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const instructionsModal = document.getElementById('instructions-modal');
      const aboutModal = document.getElementById('about-name-modal');
      if (event.target == instructionsModal) {
        closeInstructions();
      }
      if (event.target == aboutModal) {
        closeAboutName();
      }
    }

    // CONFETTI ANIMATION
    function createConfetti() {
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.classList.add('confetti');
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.animationDuration = Math.random() * 2 + 2 + 's';
          confetti.style.opacity = Math.random();
          document.body.appendChild(confetti);
          
          setTimeout(() => {
            confetti.remove();
          }, 3000);
        }, i * 50);
      }
    }

    // GAME CODE
    let playerName, roomCode, reviewEndTime, reviewInterval, isReviewPaused = false, requiredQuestionCount = 5, otherPlayerName = null;

    function createRoom() {
      playerName = document.getElementById('playerName').value.trim();
      const customCode = document.getElementById('roomCode').value.trim().toUpperCase();
      
      if (!playerName) {
        showError('auth-error', 'Please enter your name');
        document.getElementById('playerName').focus();
        return;
      }
      
      // Use custom code if provided, otherwise generate random
      roomCode = customCode || Math.random().toString(36).substring(2, 8).toUpperCase();
      document.getElementById('roomCode').value = roomCode;
      
      // Set up room with creator info
      db.ref(`rooms/${roomCode}/settings`).set({
        creator: playerName,
        createdAt: Date.now()
      });
      
      // Listen for other players joining
      listenForJoins();
      
      updateRoomInfo(roomCode, playerName);
      showSuccess('auth-error', `Room created: ${roomCode} - Share this code with your friend!`);
      announceToScreenReader(`Room created with code ${roomCode}`);
      
      // Move to game setup
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('question-setup-section').classList.remove('hidden');
    }

    function joinRoom() {
      playerName = document.getElementById('playerName').value.trim();
      roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
      
      if (!playerName) {
        showError('auth-error', 'Please enter your name');
        document.getElementById('playerName').focus();
        return;
      }
      if (!roomCode) {
        showError('room-error', 'Please enter the room code');
        document.getElementById('roomCode').focus();
        return;
      }
      
      // Check if room exists and get settings
      db.ref(`rooms/${roomCode}/settings`).once('value').then(snapshot => {
        if (snapshot.exists()) {
          const settings = snapshot.val();
          const creatorName = settings.creator;
          
          // Notify room creator
          showNotification(`${playerName} joined room ${roomCode}!`);
          
          // Add player to room
          db.ref(`rooms/${roomCode}/players/${playerName}`).set({
            joinedAt: Date.now()
          });
          
          // Listen for room updates (question count, etc.)
          listenForRoomUpdates();
          
          updateRoomInfo(roomCode, playerName, creatorName);
          showSuccess('room-error', `Joined room: ${roomCode}`);
          announceToScreenReader(`Joined room ${roomCode}`);
          
          // Wait for game setup from creator
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('waiting-section').classList.remove('hidden');
          document.getElementById('waiting-section').innerHTML = '<div class="loading-indicator">‚è≥ Waiting for room creator to set up the game...</div>';
        } else {
          showError('room-error', 'Room not found. Please check the code.');
        }
      });
    }

    function listenForJoins() {
      db.ref(`rooms/${roomCode}/players`).on('child_added', function(snapshot) {
        const joinerName = snapshot.key;
        if (joinerName !== playerName) {
          otherPlayerName = joinerName;
          showNotification(`${joinerName} joined your room ${roomCode}!`);
          updateRoomInfo(roomCode, playerName, joinerName);
        }
      });
    }

    function listenForRoomUpdates() {
      db.ref(`rooms/${roomCode}/settings`).on('value', function(snapshot) {
        const settings = snapshot.val();
        if (settings && settings.requiredQuestionCount) {
          requiredQuestionCount = settings.requiredQuestionCount;
          // Start question creation if setup is complete
          if (document.getElementById('waiting-section').innerHTML.includes('Waiting for room creator')) {
            enterQuestionMode();
          }
        }
      });
    }

    function startGameSetup() {
      requiredQuestionCount = parseInt(document.getElementById('questionCount').value);
      
      // Update room settings
      db.ref(`rooms/${roomCode}/settings`).update({
        requiredQuestionCount: requiredQuestionCount
      });
      
      document.getElementById('question-setup-section').classList.add('hidden');
      enterQuestionMode();
    }

    function enterQuestionMode() {
      document.getElementById('waiting-section').classList.add('hidden');
      document.getElementById('question-section').classList.remove('hidden');
      
      // Update UI to show required question count
      document.querySelector('#question-section h3').textContent = `Add Your Questions (${requiredQuestionCount} required)`;
      
      addQuestion();
      announceToScreenReader('Now in question creation mode');
    }

    function addQuestion(qData = null) {
      const container = document.getElementById('questions-container');
      const currentCount = container.children.length;
      
      if (currentCount >= requiredQuestionCount * 2) {
        showError('question-error', `Maximum ${requiredQuestionCount * 2} questions allowed`);
        return;
      }
      
      const div = document.createElement('div');
      div.className = 'question-block';
      div.innerHTML = `
        <input class="main-question-input" placeholder="e.g. What is my favorite color?" aria-label="Question" value="${qData ? qData.question : ''}">
        <input placeholder="Option 1 (e.g. Blue)" class="option-input" aria-label="Option 1" value="${qData ? qData.options[0] : ''}">
        <input placeholder="Option 2 (e.g. Red)" class="option-input" aria-label="Option 2" value="${qData ? qData.options[1] : ''}">
        <input placeholder="Option 3 (e.g. Green)" class="option-input" aria-label="Option 3" value="${qData ? qData.options[2] : ''}">
        <input placeholder="Option 4 (e.g. Yellow)" class="option-input" aria-label="Option 4" value="${qData ? qData.options[3] : ''}">
        <select aria-label="Correct Answer">
          <option value="">Select Correct Answer</option>
          <option value="1" ${qData && qData.correct == "1" ? "selected" : ""}>Option 1</option>
          <option value="2" ${qData && qData.correct == "2" ? "selected" : ""}>Option 2</option>
          <option value="3" ${qData && qData.correct == "3" ? "selected" : ""}>Option 3</option>
          <option value="4" ${qData && qData.correct == "4" ? "selected" : ""}>Option 4</option>
        </select>
        <button class="edit-btn hidden">Edit</button>
        <button class="delete-btn">Delete</button>
      `;
      container.appendChild(div);

      div.querySelector('.delete-btn').onclick = () => {
        div.remove();
        announceToScreenReader('Question deleted');
      };
      
      div.querySelector('.edit-btn').onclick = () => {
        Array.from(div.querySelectorAll('input, select')).forEach(el => el.disabled = false);
        div.querySelector('.edit-btn').classList.add('hidden');
        announceToScreenReader('Question unlocked for editing');
      };
      
      if (!qData) {
        div.querySelector('.main-question-input').focus();
      }
    }

    function submitQuestions() {
      const blocks = document.querySelectorAll('.question-block');
      
      if (blocks.length < requiredQuestionCount) {
        showError('question-error', `Please add at least ${requiredQuestionCount} questions before submitting`);
        return;
      }

      let questions = [];
      let hasErrors = false;
      
      blocks.forEach((b, index) => {
        const q = b.querySelector('.main-question-input').value.trim();
        const opts = Array.from(b.querySelectorAll('.option-input')).map(o => o.value.trim());
        const correct = b.querySelector('select').value;
        
        if (!q) {
          showError('question-error', `Question ${index + 1}: Please enter a question`);
          hasErrors = true;
          return;
        }
        if (!opts.every(o => o)) {
          showError('question-error', `Question ${index + 1}: Please fill out all 4 options`);
          hasErrors = true;
          return;
        }
        if (!correct) {
          showError('question-error', `Question ${index + 1}: Please select the correct answer`);
          hasErrors = true;
          return;
        }
        
        questions.push({ question: q, options: opts, correct });
      });
      
      // Only take the required number of questions
      questions = questions.slice(0, requiredQuestionCount);
      
      if (hasErrors || questions.length < requiredQuestionCount) return;

      document.getElementById('submit-btn').disabled = true;
      document.getElementById('submit-btn').textContent = 'Submitting...';
      
      db.ref(`rooms/${roomCode}/questions/${playerName}`).set(questions)
        .then(() => {
          showSuccess('question-error', 'Questions submitted! You now have 1 minute to review and make changes.');
          reviewEndTime = Date.now() + (1 * 60 * 1000); // 1 min
          startReviewTimerVisible();
          announceToScreenReader('Questions submitted successfully. Review period started.');
        })
        .catch(err => {
          showError('question-error', 'Failed to save your questions. Please try again.');
          document.getElementById('submit-btn').disabled = false;
          document.getElementById('submit-btn').textContent = 'Submit Questions';
          console.error(err);
        });
    }

    function startReviewTimerVisible() {
      document.getElementById('review-timer-visible').style.display = 'inline';
      document.getElementById('review-timer-visible').classList.remove('hidden');
      const timerEl = document.getElementById('timer-visible');
      document.querySelectorAll('.question-block input, .question-block select').forEach(el => el.disabled = false);
      isReviewPaused = false;

      function updateTimer() {
        if (isReviewPaused) return;
        
        let diff = reviewEndTime - Date.now();
        if (diff <= 0) {
          clearInterval(reviewInterval);
          document.getElementById('review-timer-visible').innerHTML = "Reflection time ended!";
          document.querySelectorAll('.question-block input, .question-block select').forEach(el => el.disabled = true);
          document.querySelectorAll('.edit-btn').forEach(btn => btn.classList.remove('hidden'));
          
          showStateMessage("üïê Time's up! Waiting for other player to finish...");
          announceToScreenReader('Review time ended. Waiting for other player.', true);
          
          setTimeout(startAnswering, 900);
        } else {
          let m = Math.floor(diff / 60000);
          let s = Math.floor((diff % 60000) / 1000);
          timerEl.innerText = `${m}:${s < 10 ? '0' + s : s}`;
          if (diff < 30000) {
            timerEl.classList.add('low-time');
            if (diff <= 10000 && s % 5 === 0) {
              announceToScreenReader(`${s} seconds remaining`, true);
            }
          }
        }
      }

      reviewInterval = setInterval(updateTimer, 1000);
      updateTimer(); // Initial call
    }

    function pauseAndEdit() {
      isReviewPaused = true;
      clearInterval(reviewInterval);
      
      document.getElementById('review-timer-visible').innerHTML = 
        '‚è∏Ô∏è Timer Paused - Make your changes and resubmit when ready';
      
      document.getElementById('submit-btn').disabled = false;
      document.getElementById('submit-btn').textContent = 'Resubmit Questions';
      
      showStateMessage("Timer paused! Make your changes and resubmit.");
      announceToScreenReader('Timer paused. You can now make changes.');
    }

    let waitStartTime;
    function startWaitingTimer() {
      waitStartTime = Date.now();
      const timerEl = document.getElementById('wait-timer');
      function updateTimer() {
        let diff = Date.now() - waitStartTime;
        let m = Math.floor(diff / 60000);
        let s = Math.floor((diff % 60000) / 1000);
        timerEl.innerText = `(${m}:${s < 10 ? '0' + s : s})`;
        if (!document.getElementById('waiting-section').classList.contains('hidden'))
          setTimeout(updateTimer, 1000);
        else
          timerEl.innerText = '';
      }
      updateTimer();
    }

    let questionsListener = null;
    function startAnswering() {
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById('answer-section').classList.remove('hidden');
      document.getElementById('waiting-section').classList.remove('hidden');
      document.getElementById('waiting-answers').classList.remove('hidden');
      startWaitingTimer();
      announceToScreenReader('Now waiting for other player to submit questions');
      
      if (questionsListener) {
        questionsListener.off();
        questionsListener = null;
      }
      const questionsRef = db.ref(`rooms/${roomCode}/questions`);
      questionsListener = questionsRef;
      questionsRef.on('value', function(snap) {
        const all = snap.val();
        if (!all) return;
        const otherPlayer = Object.keys(all).find(name => name !== playerName);
        if (otherPlayer) {
          const qs = all[otherPlayer];
          document.getElementById('waiting-section').classList.add('hidden');
          document.getElementById('waiting-answers').classList.add('hidden');
          showQuestionsToAnswer(qs, otherPlayer);
          questionsRef.off('value');
          announceToScreenReader(`Questions loaded from ${otherPlayer}. Ready to answer!`);
        }
      }, function(error) {
        showError('answer-error', 'Error loading questions. Please refresh and try again.');
        console.error(error);
      });
    }

    function showQuestionsToAnswer(qs, otherPlayer) {
      const container = document.getElementById('answer-container');
      container.innerHTML = '';
      qs.forEach((q, i) => {
        let div = document.createElement('div');
        div.className = 'question-block';
        div.innerHTML = `<p><strong>${i+1}. ${q.question}</strong></p>` +
          q.options.map((o, idx) =>
            `<label style="display: block; margin: 8px 0; cursor: pointer;">
              <input type="radio" name="q${i}" value="${idx+1}" style="margin-right: 8px;"> ${o}
            </label>`
          ).join('');
        container.appendChild(div);
      });
      container.setAttribute('data-other-player', otherPlayer);
    }

    function submitAnswers() {
      const blocks = document.querySelectorAll('#answer-container .question-block');
      let answers = [];
      let hasError = false;
      let firstEmptyQuestion = null;
      
      blocks.forEach((b, i) => {
        const selected = b.querySelector('input[type=radio]:checked');
        if (!selected) {
          hasError = true;
          if (!firstEmptyQuestion) firstEmptyQuestion = i + 1;
        }
        answers.push(selected ? selected.value : null);
      });
      
      if (hasError) {
        showError('answer-error', `Please answer all questions. Missing answer for question ${firstEmptyQuestion}.`);
        const firstEmpty = document.querySelector(`input[name="q${firstEmptyQuestion-1}"]`);
        if (firstEmpty) firstEmpty.focus();
        return;
      }
      
      document.getElementById('waiting-answers').classList.remove('hidden');
      announceToScreenReader('Submitting answers...');
      
      db.ref(`rooms/${roomCode}/answers/${playerName}`).set(answers)
        .then(() => {
          waitForBothAnswers(answers);
        })
        .catch(err => {
          showError('answer-error', 'Failed to save your answers. Please try again.');
          document.getElementById('waiting-answers').classList.add('hidden');
          console.error(err);
        });
    }

    function waitForBothAnswers(myAnswers) {
      const otherPlayer = document.getElementById('answer-container').getAttribute('data-other-player');
      const answersRef = db.ref(`rooms/${roomCode}/answers`);
      const questionsRef = db.ref(`rooms/${roomCode}/questions`);
      
      answersRef.on('value', function(snap) {
        const allAnswers = snap.val();
        if (allAnswers && allAnswers[playerName] && allAnswers[otherPlayer]) {
          questionsRef.once('value').then(snap => {
            const allQuestions = snap.val();
            calculateResults(
              myAnswers,
              allQuestions[otherPlayer],
              otherPlayer,
              allQuestions,
              allAnswers[otherPlayer]
            );
            document.getElementById('waiting-answers').classList.add('hidden');
            answersRef.off();
          });
        }
      });
    }

    function calculateResults(answers, qs, otherPlayer, all, otherPlayerAnswers = null) {
      let correctCount = 0;
      let breakdown = '';
      qs.forEach((q, i) => {
        let isCorrect = answers[i] == q.correct;
        if (isCorrect) correctCount++;
        breakdown += `<p><strong>${i+1}. ${q.question}</strong><br>
          Your answer: <span style="color: ${isCorrect ? '#4caf50' : '#f44336'}">${q.options[answers[i]-1] || 'No answer'}</span> ${isCorrect ? '‚úÖ' : '‚ùå'}<br>
          Correct answer: <span style="color: #4caf50">${q.options[q.correct-1]}</span></p>`;
      });
      let percent = Math.round((correctCount / qs.length) * 100);
      let tag = getLevelTag(percent);

      let otherBreakdownHTML = '';
      let otherScoreHTML = '';
      let otherCorrectCount = 0;
      if (all && all[playerName] && otherPlayerAnswers && Array.isArray(otherPlayerAnswers)) {
        let questionsForOther = all[playerName];
        let otherBreakdown = '';
        questionsForOther.forEach((q, i) => {
          let isCorrect = otherPlayerAnswers[i] == q.correct;
          if (isCorrect) otherCorrectCount++;
          otherBreakdown += `<p><strong>${i+1}. ${q.question}</strong><br>
            Their answer: <span style="color: ${isCorrect ? '#4caf50' : '#f44336'}">${q.options[otherPlayerAnswers[i]-1] || 'No answer'}</span> ${isCorrect ? '‚úÖ' : '‚ùå'}<br>
            Correct answer: <span style="color: #4caf50">${q.options[q.correct-1]}</span></p>`;
        });
        let otherPercent = Math.round((otherCorrectCount / questionsForOther.length) * 100);
        let otherTag = getLevelTag(otherPercent);
        otherScoreHTML = `<h4>${otherPlayer} scored ${otherPercent}% - ${otherTag}</h4>`;
        otherBreakdownHTML = `<h4>How ${otherPlayer} did on your questions:</h4>` + otherBreakdown;
      }

      // Trigger confetti for high scores
      if (percent >= 90 || (otherPlayerAnswers && Math.round((otherCorrectCount / all[playerName].length) * 100) >= 90)) {
        createConfetti();
      }

      document.getElementById('result-section').classList.remove('hidden');
      document.getElementById('answer-section').classList.add('hidden');
      document.getElementById('result-output').innerHTML =
        `<h4>${playerName || 'You'} scored ${percent}% - ${tag}</h4>
        <h4>Your performance on ${otherPlayer}'s questions:</h4>${breakdown}` +
        (otherScoreHTML ? `<hr style="margin: 30px 0;">${otherScoreHTML}${otherBreakdownHTML}` : "");

      announceToScreenReader(`Results ready. You scored ${percent} percent - ${tag}`);
      attemptRoomCleanup(all, playerName, otherPlayer);
    }

    function attemptRoomCleanup(allQuestions, playerName, otherPlayer) {
      db.ref(`rooms/${roomCode}/answers`).once('value').then(snap => {
        const answers = snap.val();
        if (!answers) return;
        const playerNames = [playerName, otherPlayer];
        const bothAnswered = playerNames.every(n => answers[n] && Array.isArray(answers[n]));
        if (bothAnswered) {
          setTimeout(() => {
            db.ref(`rooms/${roomCode}`).remove()
              .catch(err => {
                console.error("Failed to clean up game room: " + err.message);
              });
          }, 8000);
        }
      }).catch(err => {
        console.error("Error checking answers for cleanup: " + err.message);
      });
    }

    function getLevelTag(p) {
      if (p === 100) return "üíé Perfect Harmony";
      if (p >= 90) return "üíñ Soulmate Energy";
      if (p >= 80) return "üòä Close Confidant";
      if (p >= 70) return "ü§ù Good Friends";
      if (p >= 60) return "üôÇ Getting There";
      if (p >= 50) return "üòê Friendly Guesswork";
      if (p >= 40) return "üòÖ We Need to Talk";
      if (p >= 30) return "üò¨ Strangers Much?";
      if (p >= 20) return "ü§î Do You Even Know Me?";
      if (p >= 10) return "üò± Who Are You?";
      return "üëª Ghost Friends";
    }

    // Initialize event listeners when page loads
    window.addEventListener('load', function() {
      const aboutBtn = document.getElementById('about-name');
      if (aboutBtn) {
        aboutBtn.addEventListener('click', showAboutName);
      }
    });

    // Keyboard accessibility for modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeInstructions();
        closeAboutName();
      }
    });
  </script>
</body>
</html>