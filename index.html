<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ü™®Rock and Fishüêü Q&A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Montserrat font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Shared variables */
      --font-main: 'Montserrat', 'Segoe UI', Arial, sans-serif;
    }

    body {
      font-family: var(--font-main);
      margin: 0; padding: 0;
      text-align: center;
      overflow-x: hidden;
      transition: background 0.4s, color 0.4s;
    }

    /* --- LIGHT THEME --- */
    .light-theme {
      background: linear-gradient(120deg, #ffd6e1 0%, #c9f6f9 100%);
      color: #222;
      font-family: var(--font-main);
    }
    .light-theme h1 {
      font-size: 2.7em;
      font-weight: 700;
      color: #232323;
      margin-top: 32px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
      line-height: 1.15;
      font-family: var(--font-main);
    }
    .light-theme h3 {
      font-size: 1.35em;
      font-weight: 600;
      color: #232323;
      margin-bottom: 24px;
      margin-top: 0;
      font-family: var(--font-main);
    }
    .light-theme input, .light-theme select {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      border: 1.5px solid #d8e0e6;
      padding: 10px 18px;
      background: #f5f8fa;
      color: #232323;
      margin: 0 6px 10px 0;
      outline: none;
      transition: border 0.3s;
      box-sizing: border-box;
    }
    .light-theme input:focus, .light-theme select:focus {
      border-color: #ff80a8;
      box-shadow: 0 0 7px #ffb7d1bb;
    }
    .light-theme button {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      background: #ff80a8;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 10px 22px;
      margin: 8px 6px 0 0;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: 0 2px 8px #ffb7d155;
      letter-spacing: 0.4px;
    }
    .light-theme button:hover:not(:disabled) {
      background: #ff5a91;
      transform: scale(1.05);
    }
    .light-theme button:disabled {
      background: #eee;
      color: #aaa;
      cursor: not-allowed;
    }
    .light-theme .question-block {
      background: #fff;
      color: #232323;
      font-family: var(--font-main);
      box-shadow: 0 4px 16px 0 #e6f4f8bb;
      border-radius: 10px;
      padding: 18px 16px;
      margin: 18px auto;
      max-width: 500px;
      text-align: left;
      position: relative;
    }
    .light-theme .option-input {
      margin-bottom: 6px;
    }
    .light-theme .timer {
      color: #ff5a91;
      font-weight: 700;
      font-family: var(--font-main);
    }
    .light-theme .timer.low-time {
      color: #ff80a8;
    }
    .light-theme .theme-switch {
      color: #ff80a8;
      background: none;
      font-size: 1.7em;
      border-radius: 50%;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 0;
      position: absolute;
      top: 18px;
      right: 20px;
    }
    .light-theme .theme-switch:hover {
      background: #ffe0ec;
    }
    .light-theme .loading-indicator {
      color: #ff80a8;
      font-size: 1.1em;
      margin: 14px 0;
      animation: pulse-loading 1.2s infinite;
    }

    /* --- DARK THEME --- */
    .dark-theme {
      background: linear-gradient(135deg, #745100 0%, #000000 100%);
      color: #fff;
      font-family: var(--font-main);
    }
    .dark-theme h1 {
      font-size: 2.4em;
      font-weight: 700;
      color: #ffd26b;
      letter-spacing: 0.5px;
      font-family: var(--font-main);
      margin-top: 32px;
      margin-bottom: 10px;
      line-height: 1.15;
    }
    .dark-theme h3 {
      font-size: 1.25em;
      font-weight: 600;
      color: #ffe9b3;
      margin-bottom: 24px;
      margin-top: 0;
      font-family: var(--font-main);
    }
    .dark-theme input, .dark-theme select {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      border: 1.5px solid #444;
      padding: 10px 18px;
      background: #222;
      color: #fff;
      margin: 0 6px 10px 0;
      outline: none;
      transition: border 0.3s;
      box-sizing: border-box;
    }
    .dark-theme input:focus, .dark-theme select:focus {
      border-color: #ffd26b;
      box-shadow: 0 0 7px #ffd26bbb;
    }
    .dark-theme button {
      font-family: var(--font-main);
      font-size: 1.1em;
      border-radius: 8px;
      background: #ff567d;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 10px 22px;
      margin: 8px 6px 0 0;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: 0 2px 8px #ffd26b55;
      letter-spacing: 0.4px;
    }
    .dark-theme button:hover:not(:disabled) {
      background: #ffd26b;
      color: #432200;
      transform: scale(1.05);
    }
    .dark-theme button:disabled {
      background: #444;
      color: #ccc;
      cursor: not-allowed;
    }
    .dark-theme .question-block {
      background: #222;
      color: #ffe9b3;
      font-family: var(--font-main);
      box-shadow: 0 4px 16px 0 #000000bb;
      border-radius: 10px;
      padding: 18px 16px;
      margin: 18px auto;
      max-width: 500px;
      text-align: left;
      position: relative;
    }
    .dark-theme .option-input {
      margin-bottom: 6px;
    }
    .dark-theme .timer {
      color: #ffd26b;
      font-weight: 700;
      font-family: var(--font-main);
    }
    .dark-theme .timer.low-time {
      color: #ff567d;
    }
    .dark-theme .theme-switch {
      color: #ffd26b;
      background: none;
      font-size: 1.7em;
      border-radius: 50%;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 0;
      position: absolute;
      top: 18px;
      right: 20px;
    }
    .dark-theme .theme-switch:hover {
      background: #432200;
    }
    .dark-theme .loading-indicator {
      color: #ffd26b;
      font-size: 1.1em;
      margin: 14px 0;
      animation: pulse-loading 1.2s infinite;
    }

    /* Shared styles */
    .section {
      animation: fadeIn 0.6s ease;
    }
    .question-block {
      transition: transform 0.3s, box-shadow 0.3s;
      animation: fadeInUp 0.5s ease;
    }
    .question-block:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.13);
    }
    .option-input { display: block; }
    .hidden { display: none; }
    .timer {
      font-weight: bold;
      animation: fadeIn 0.5s ease;
    }
    .timer.low-time {
      animation: pulse 1s infinite;
    }
    .error { border: 1px solid red; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    @keyframes fadeInDown { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
    @keyframes fadeInUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
    @keyframes pulse {
      0%, 100% { transform: scale(1);}
      50% { transform: scale(1.1);}
    }
    @keyframes pulse-loading {
      0%, 100% { opacity: 1;}
      50% { opacity: 0.5;}
    }

    /* Responsive: Center form fields for main screen */
    @media (max-width: 600px) {
      .light-theme h1, .dark-theme h1 { font-size: 2em; }
      .light-theme h3, .dark-theme h3 { font-size: 1.1em; }
      .question-block { max-width: 98vw; padding: 11px 4vw; }
      .theme-switch { top: 8px; right: 8px; }
    }
    .edit-btn, .delete-btn {
      font-size: 0.95em;
      margin-left: 8px;
      padding: 4px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .edit-btn:hover, .delete-btn:hover {
      opacity: 1;
    }
    .edit-btn {
      background: #ffe9b3;
      color: #222;
    }
    .delete-btn {
      background: #ff567d;
      color: #fff;
    }
    .edit-btn:disabled, .delete-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <!-- Firebase SDKs: App and Database (Compat for window.firebase) -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database-compat.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAvaDuz1OCKYuDfieZiHynhYkur9KOPY00",
      authDomain: "birdview-025802.firebaseapp.com",
      databaseURL: "https://birdview-025802-default-rtdb.firebaseio.com/",
      projectId: "birdview-025802",
      storageBucket: "birdview-025802.firebasestorage.app",
      messagingSenderId: "607338097846",
      appId: "1:607338097846:web:2ac36ce8f1261664180a17",
      measurementId: "G-Z08YPG773L"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    // Create a database reference for use elsewhere
    const db = firebase.database();
  </script>
</head>
<body class="dark-theme">
  <button class="theme-switch" id="theme-switch" aria-label="Switch theme" title="Switch theme">üåû</button>
  <h1>ü™®Rock and Fishüêü Q&A Game</h1>

  <div id="auth-section" class="section">
    <h3>Join or Create Game</h3>
    <input id="playerName" placeholder="Your Name" aria-label="Player Name">
    <input id="roomCode" placeholder="Room Code" aria-label="Room Code">
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <div id="question-section" class="section hidden">
    <h3>Add Your Questions</h3>
    <div id="questions-container"></div>
    <button onclick="addQuestion()">+ Add Question</button>
    <br>
    <button onclick="submitQuestions()">Submit Questions</button>
    <div id="review-timer" class="hidden">‚è≥ Review Time Left: <span id="timer" class="timer"></span></div>
  </div>

  <div id="waiting-section" class="section hidden">
    <div class="loading-indicator">
      ‚è≥ Waiting for the other player to submit questions...
      <span id="wait-timer" class="timer"></span>
    </div>
  </div>

  <div id="answer-section" class="section hidden">
    <h3>Answer Your Friend's Questions</h3>
    <div id="answer-container"></div>
    <button onclick="submitAnswers()">Submit Answers</button>
    <div id="waiting-answers" class="hidden loading-indicator">‚è≥ Loading questions...</div>
  </div>

  <div id="result-section" class="section hidden">
    <h3>Results</h3>
    <div id="result-output"></div>
    <button onclick="location.reload()">Play Again</button>
  </div>

  <script>
    // THEME SWITCHER
    const themeSwitchBtn = document.getElementById('theme-switch');
    const body = document.body;
    function setTheme(theme) {
      if (theme === 'light') {
        body.classList.add('light-theme');
        body.classList.remove('dark-theme');
        themeSwitchBtn.textContent = 'üåô';
        themeSwitchBtn.title = 'Switch to dark theme';
      } else {
        body.classList.add('dark-theme');
        body.classList.remove('light-theme');
        themeSwitchBtn.textContent = 'üåû';
        themeSwitchBtn.title = 'Switch to light theme';
      }
    }
    // Load theme preference
    const savedTheme = localStorage.getItem('theme');
    setTheme(savedTheme || 'dark');
    themeSwitchBtn.onclick = function() {
      const isDark = body.classList.contains('dark-theme');
      setTheme(isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    };

    // GAME CODE
    let playerName, roomCode, reviewEndTime;

    function createRoom() {
      playerName = document.getElementById('playerName').value.trim();
      if (!playerName) return alert("Enter your name");
      roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      document.getElementById('roomCode').value = roomCode;
      alert(`Room created: ${roomCode}`);
      enterQuestionMode();
    }

    function joinRoom() {
      playerName = document.getElementById('playerName').value.trim();
      roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
      if (!playerName || !roomCode) return alert("Enter both name and room code");
      alert("Joined room: " + roomCode);
      enterQuestionMode();
    }

    function enterQuestionMode() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('question-section').classList.remove('hidden');
      addQuestion();
    }

    function addQuestion(qData = null) {
      const container = document.getElementById('questions-container');
      const div = document.createElement('div');
      div.className = 'question-block';
      div.innerHTML = `
        <input placeholder="Question" aria-label="Question" value="${qData ? qData.question : ''}">
        <input placeholder="Option 1" class="option-input" aria-label="Option 1" value="${qData ? qData.options[0] : ''}">
        <input placeholder="Option 2" class="option-input" aria-label="Option 2" value="${qData ? qData.options[1] : ''}">
        <input placeholder="Option 3" class="option-input" aria-label="Option 3" value="${qData ? qData.options[2] : ''}">
        <input placeholder="Option 4" class="option-input" aria-label="Option 4" value="${qData ? qData.options[3] : ''}">
        <select aria-label="Correct Answer">
          <option value="">Select Correct Answer</option>
          <option value="1" ${qData && qData.correct == "1" ? "selected" : ""}>Option 1</option>
          <option value="2" ${qData && qData.correct == "2" ? "selected" : ""}>Option 2</option>
          <option value="3" ${qData && qData.correct == "3" ? "selected" : ""}>Option 3</option>
          <option value="4" ${qData && qData.correct == "4" ? "selected" : ""}>Option 4</option>
        </select>
        <button class="edit-btn hidden">Edit</button>
        <button class="delete-btn">Delete</button>
      `;
      container.appendChild(div);

      // Delete handler
      div.querySelector('.delete-btn').onclick = () => {
        div.remove();
      };

      // Edit handler (for toggling edit mode, not needed on add, but for future inline editing support)
      div.querySelector('.edit-btn').onclick = () => {
        Array.from(div.querySelectorAll('input, select')).forEach(el => el.disabled = false);
        div.querySelector('.edit-btn').classList.add('hidden');
      };
    }

    // Allow editing inline: If a question is not disabled, it's editable.
    // On submit, disable inputs.

    function submitQuestions() {
      const blocks = document.querySelectorAll('.question-block');
      let questions = [];
      blocks.forEach(b => {
        const q = b.querySelector('input').value.trim();
        const opts = Array.from(b.querySelectorAll('.option-input')).map(o => o.value.trim());
        const correct = b.querySelector('select').value;
        if (q && opts.every(o => o) && correct) {
          questions.push({ question: q, options: opts, correct });
          // Disable editing after submission
          Array.from(b.querySelectorAll('input, select')).forEach(el => el.disabled = true);
          b.querySelector('.edit-btn').classList.remove('hidden');
        }
      });
      if (questions.length === 0) return alert("Add at least one valid question");
      // Save questions to Firebase under this player in the room
      db.ref(`rooms/${roomCode}/questions/${playerName}`).set(questions)
        .then(() => {
          reviewEndTime = Date.now() + (1 * 60 * 1000) + (30 * 1000); // 1 min 30 sec
          startReviewTimer();
        })
        .catch(err => {
          alert("Failed to save your questions. Please try again.\n" + err.message);
        });
    }

    function startReviewTimer() {
      document.getElementById('review-timer').classList.remove('hidden');
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        let diff = reviewEndTime - Date.now();
        if (diff <= 0) {
          clearInterval(interval);
          document.getElementById('review-timer').innerText = "Review ended!";
          startAnswering();
        } else {
          let m = Math.floor(diff / 60000);
          let s = Math.floor((diff % 60000) / 1000);
          timerEl.innerText = `${m}:${s < 10 ? '0' + s : s}`;
          if (diff < 30000) timerEl.classList.add('low-time');
        }
      }, 1000);
    }

    // Waiting timer for other player's questions
    let waitStartTime;
    function startWaitingTimer() {
      waitStartTime = Date.now();
      const timerEl = document.getElementById('wait-timer');
      function updateTimer() {
        let diff = Date.now() - waitStartTime;
        let m = Math.floor(diff / 60000);
        let s = Math.floor((diff % 60000) / 1000);
        timerEl.innerText = `${m}:${s < 10 ? '0' + s : s}`;
        if (!document.getElementById('waiting-section').classList.contains('hidden'))
          setTimeout(updateTimer, 1000);
        else
          timerEl.innerText = '';
      }
      updateTimer();
    }

    // Step 1: Improved Real-Time Sync (Listener instead of polling)
    let questionsListener = null;
    function startAnswering() {
      document.getElementById('question-section').classList.add('hidden');
      document.getElementById('answer-section').classList.remove('hidden');
      document.getElementById('waiting-section').classList.remove('hidden');
      document.getElementById('waiting-answers').classList.remove('hidden');
      startWaitingTimer();
      // Remove previous listener if any
      if (questionsListener) {
        questionsListener.off();
        questionsListener = null;
      }
      // Set up a real-time listener for other player's questions
      const questionsRef = db.ref(`rooms/${roomCode}/questions`);
      questionsListener = questionsRef;
      questionsRef.on('value', function(snap) {
        const all = snap.val();
        if (!all) return;
        const otherPlayer = Object.keys(all).find(name => name !== playerName);
        if (otherPlayer) {
          const qs = all[otherPlayer];
          document.getElementById('waiting-section').classList.add('hidden');
          document.getElementById('waiting-answers').classList.add('hidden');
          showQuestionsToAnswer(qs, otherPlayer);
          // Remove listener after we've received the questions (to avoid repeat triggers)
          questionsRef.off('value');
        }
      }, function(error) {
        alert("Error listening for other player's questions: " + error.message);
      });
    }

    function showQuestionsToAnswer(qs, otherPlayer) {
      const container = document.getElementById('answer-container');
      container.innerHTML = '';
      qs.forEach((q, i) => {
        let div = document.createElement('div');
        div.className = 'question-block';
        div.innerHTML = `<p>${i+1}. ${q.question}</p>` +
          q.options.map((o, idx) =>
            `<label><input type="radio" name="q${i}" value="${idx+1}"> ${o}</label><br>`
          ).join('');
        container.appendChild(div);
      });
      container.setAttribute('data-other-player', otherPlayer);
    }

    function submitAnswers() {
      const blocks = document.querySelectorAll('#answer-container .question-block');
      let answers = [];
      let hasError = false;
      blocks.forEach((b, i) => {
        const selected = b.querySelector('input[type=radio]:checked');
        if (!selected) hasError = true;
        answers.push(selected ? selected.value : null);
      });
      if (hasError) return alert("Please answer all questions");

      // Show loading indicator while calculating results
      document.getElementById('waiting-answers').classList.remove('hidden');

      // Load the questions you just answered from Firebase for result calculation
      db.ref(`rooms/${roomCode}/questions`).once('value').then(snap => {
        const all = snap.val();
        const otherPlayer = document.getElementById('answer-container').getAttribute('data-other-player');
        const qs = all && all[otherPlayer];
        calculateResults(answers, qs, otherPlayer, all);
        document.getElementById('waiting-answers').classList.add('hidden');
      }).catch(err => {
        alert("Failed to load questions from database. Please try again.\n" + err.message);
        document.getElementById('waiting-answers').classList.add('hidden');
      });
    }

    function calculateResults(answers, qs, otherPlayer, all) {
      let correctCount = 0;
      let breakdown = '';
      qs.forEach((q, i) => {
        let isCorrect = answers[i] == q.correct;
        if (isCorrect) correctCount++;
        breakdown += `<p>${i+1}. ${q.question} <br>
          Your answer: ${q.options[answers[i]-1] || 'No answer'} ${isCorrect ? '‚úÖ' : '‚ùå'}<br>
          Correct: ${q.options[q.correct-1]}</p>`;
      });
      let percent = Math.round((correctCount / qs.length) * 100);
      let tag = getLevelTag(percent);

      // Show both players' scores if possible
      let otherBreakdownHTML = '';
      let otherScoreHTML = '';
      if (all && all[playerName]) {
        // Other player answered your questions? Try to show their score:
        db.ref(`rooms/${roomCode}/answers/${otherPlayer}`).once('value').then(answerSnap => {
          const otherAnswers = answerSnap.val();
          if (otherAnswers && Array.isArray(otherAnswers)) {
            let questionsForOther = all[playerName];
            let otherCorrectCount = 0;
            let otherBreakdown = '';
            questionsForOther.forEach((q, i) => {
              let isCorrect = otherAnswers[i] == q.correct;
              if (isCorrect) otherCorrectCount++;
              otherBreakdown += `<p>${i+1}. ${q.question} <br>
                Their answer: ${q.options[otherAnswers[i]-1] || 'No answer'} ${isCorrect ? '‚úÖ' : '‚ùå'}<br>
                Correct: ${q.options[q.correct-1]}</p>`;
            });
            let otherPercent = Math.round((otherCorrectCount / questionsForOther.length) * 100);
            let otherTag = getLevelTag(otherPercent);
            otherScoreHTML = `<h4>${otherPlayer} scored ${otherPercent}% - ${otherTag}</h4>`;
            otherBreakdownHTML = otherBreakdown;
          }
          document.getElementById('result-section').classList.remove('hidden');
          document.getElementById('answer-section').classList.add('hidden');
          document.getElementById('result-output').innerHTML =
            `<h4>${playerName || 'You'}, you scored ${percent}% - ${tag}</h4>${breakdown}` +
            (otherScoreHTML ? `<hr><h4>Comparison:</h4>${otherScoreHTML}${otherBreakdownHTML}` : "");
          // Step 4: Data Cleanup - remove room data after both answered
          attemptRoomCleanup(all, playerName, otherPlayer);
        }).catch(err => {
          alert("Failed to load the other player's answers for comparison. " + err.message);
          document.getElementById('result-section').classList.remove('hidden');
          document.getElementById('answer-section').classList.add('hidden');
          document.getElementById('result-output').innerHTML =
            `<h4>${playerName || 'You'}, you scored ${percent}% - ${tag}</h4>${breakdown}`;
          attemptRoomCleanup(all, playerName, otherPlayer);
        });
      } else {
        document.getElementById('result-section').classList.remove('hidden');
        document.getElementById('answer-section').classList.add('hidden');
        document.getElementById('result-output').innerHTML =
          `<h4>${playerName || 'You'}, you scored ${percent}% - ${tag}</h4>${breakdown}`;
        attemptRoomCleanup(all, playerName, otherPlayer);
      }

      // Save your answers (for comparison display for other player)
      db.ref(`rooms/${roomCode}/answers/${playerName}`).set(answers).catch(err => {
        alert("Failed to save your answers. Please try again.\n" + err.message);
      });
    }

    // Step 4: Data Cleanup - remove old game data after both players finished
    function attemptRoomCleanup(allQuestions, playerName, otherPlayer) {
      // Check if both players have submitted their answers
      db.ref(`rooms/${roomCode}/answers`).once('value').then(snap => {
        const answers = snap.val();
        if (!answers) return;
        const playerNames = [playerName, otherPlayer];
        const bothAnswered = playerNames.every(n => answers[n] && Array.isArray(answers[n]));
        if (bothAnswered) {
          // Wait 8 seconds before deleting to ensure both see their results
          setTimeout(() => {
            db.ref(`rooms/${roomCode}`).remove()
              .catch(err => {
                // Not critical, just log
                console.error("Failed to clean up game room: " + err.message);
              });
          }, 8000);
        }
      }).catch(err => {
        // Not critical, just log
        console.error("Error checking answers for cleanup: " + err.message);
      });
    }

    function getLevelTag(p) {
      if (p >= 90) return "üíñ Soulmate Energy";
      if (p >= 75) return "üòä Close Confidant";
      if (p >= 50) return "ü§ù Friendly Guesswork";
      return "üòÖ We Need to Talk...";
    }
  </script>
</body>
</html>
